<!DOCTYPE html>
<meta charset="UTF-8">
<html>
<head>
    <title>Desynced blueprint decoder/encoder</title>
    <style>
        .buttons__switch {
            margin-block: 2ex;
        }
    </style>
</head>
<body>
    <div id="game-mode">
        <div class="buttons buttons__switch">
            <button data-action="goto-ron">Clear and switch to RON</button>
            <button data-action="goto-json">Clear and switch to JSON</button>
        </div>
        <h2>Encoded (blueprint/behavior string)</h2>
        <textarea style="min-width: 600px;" rows="15"></textarea>
        <div class="buttons">
            <button data-action="convert-game-to-ron">Decode to RON</button>
            <button data-action="convert-game-to-json">Decode to JSON</button>
        </div>
        <div class="errors"></div>
    </div>
    <div id="ron-mode">
        <div class="buttons buttons__switch">
            <button data-action="goto-game">Clear and switch to blueprint</button>
        </div>
        <h2>Decoded (RON)</h2>
        <textarea style="min-width: 600px;" rows="15"></textarea>
        <div class="buttons">
            <button data-action="convert-ron-to-game">Encode</button>
        </div>
        <div class="errors"></div>
    </div>
    <div id="json-mode">
        <div class="buttons buttons__switch">
            <button data-action="goto-game">Clear and switch to blueprint</button>
        </div>
        <h2>Decoded (JSON)</h2>
        <textarea style="min-width: 600px;" rows="15"></textarea>
        <div class="buttons">
            <button data-action="convert-json-to-game">Encode</button>
        </div>
        <div class="errors"></div>
    </div>
</body>
<script type="module">
    import * as desynced_exchange_web from "./pkg/desynced_exchange_web.js";

    class StateMaintainer {
        constructor(states, startState) {
            this.states = states;
            this._checkState(startState);
            this.state = startState;
        }
        _checkState(state) {
            if (state === null) {
                throw new Error("Valid state cannot be null");
            }
            if (this.states[state] === undefined) {
                throw new Error("Undefined state " + state);
            }
        }
        async switchState(action, oldState, newState) {
            if (oldState === null) {
                throw new Error("Invalid action old state");
            }
            if (newState === null) {
                throw new Error("Invalid action new state");
            } else {
                this._checkState(newState);
            }
            if (this.state !== oldState) {
                throw new Error("Out-of-order action");
            }
            this.state = null;
            let result;
            try {
                result = await action();
                this.states[oldState].exit.call(this);
                this.states[newState].enter.call(this);
                this.state = newState;
            } catch (error) {
                this.state = oldState;
                throw error;
            }
            return result;
        }
    }

    async function main() {
        await desynced_exchange_web.default();
        function setupState(state) {
            let section = document.getElementById(state + "-mode");
            return {
                enter() {
                    section
                        .style.setProperty("display", null);
                },
                exit() {
                    section.style
                        .setProperty("display", "none");
                    section.querySelector('textarea')
                        .value = "";
                    section.querySelector('.errors')
                        .innerHTML = "";
                },
            }
        }
        let state = new StateMaintainer({
            "game": setupState("game"),
            "ron" : setupState("ron" ),
            "json": setupState("json"),
        }, "game");
        state.states.game.enter();
        state.states.ron .exit();
        state.states.json.exit();
        function defineConvert(src, dst, conversion) {
            if (src == dst) {
                throw new Error("invalid action");
            }
            let action = () => {
                state.switchState(() => {
                    try {
                        let input = document.getElementById(src + "-mode")
                            .querySelector('textarea');
                        let output = document.getElementById(dst + "-mode")
                            .querySelector('textarea');
                        output.value = conversion(input.value.trim());
                    } catch (error) {
                        document.getElementById(src + "-mode")
                            .querySelector('.errors')
                            .innerHTML = error
                        throw error;
                    }
                }, src, dst)
            };
            document.getElementById(src + "-mode")
                .querySelector("button[data-action=convert-" + src + "-to-" + dst + "]")
                .addEventListener("click", action);
            // XXX need to detect last used RON/JSON
            // document.getElementById(src + "-mode")
            //     .querySelector("textarea")
            //     .addEventListener("keydown", (e) => {
            //         if (e.keyCode != 13 || !e.ctrlKey) {
            //             return;
            //         }
            //         return action();
            //     })
        }
        defineConvert("game", "ron" , desynced_exchange_web.exchange_to_ron );
        defineConvert("game", "json", desynced_exchange_web.exchange_to_json);
        defineConvert("ron" , "game", desynced_exchange_web.ron_to_exchange );
        defineConvert("json", "game", desynced_exchange_web.json_to_exchange);
        function defineGoto(src, dst) {
            if (src == dst) {
                throw new Error("invalid action");
            }
            document.getElementById(src + "-mode")
            .querySelector("button[data-action=goto-" + dst + "]")
            .addEventListener("click", () => {
                state.switchState(() => {}, src, dst)
            });
        }
        defineGoto("game", "ron" );
        defineGoto("game", "json");
        defineGoto("ron" , "game");
        defineGoto("json", "game");
    }

    main();
</script>
</html>
